<script>
const supabase = supabase.createClient(
  "vmtizubcbzcscvrjnbkc",
  "sb_publishable_yTBSdMmjv1qIH8V9FViobw_DBIwtm_D"
);

const dataSelect = document.getElementById("data");
const horarioSelect = document.getElementById("horario");
const form = document.getElementById("form");
const msg = document.getElementById("msg");

// GERAR PRÓXIMOS 6 DIAS (SEM DOMINGO)
function gerarDias() {
    dataSelect.innerHTML = '<option value="">Selecione o dia</option>';
    const hoje = new Date();

    let diasAdicionados = 0;
    let i = 0;

    while (diasAdicionados < 6) {
        let data = new Date();
        data.setDate(hoje.getDate() + i);

        if (data.getDay() !== 0) { // ignora domingo
            const option = document.createElement("option");
            const iso = data.toISOString().split("T")[0];
            option.value = iso;
            option.textContent = data.toLocaleDateString("pt-BR");
            dataSelect.appendChild(option);
            diasAdicionados++;
        }
        i++;
    }
}

function gerarHorarios() {
    let horarios = [];
    for (let h = 8; h <= 15; h++) {
        horarios.push(`${String(h).padStart(2,'0')}:00`);
        if (h !== 15) horarios.push(`${String(h).padStart(2,'0')}:30`);
    }
    return horarios;
}

dataSelect.addEventListener("change", async () => {
    horarioSelect.innerHTML = '<option value="">Carregando...</option>';

    const { data: agendados } = await supabase
        .from("agendamentos")
        .select("horario")
        .eq("data", dataSelect.value);

    const ocupados = agendados.map(a => a.horario.slice(0,5));
    const todos = gerarHorarios();

    horarioSelect.innerHTML = '<option value="">Selecione um horário</option>';

    todos.forEach(h => {
        if (!ocupados.includes(h)) {
            const option = document.createElement("option");
            option.value = h;
            option.textContent = h;
            horarioSelect.appendChild(option);
        }
    });
});

form.addEventListener("submit", async (e) => {
    e.preventDefault();

    const nome = document.getElementById("nome").value.trim();
    const telefone = document.getElementById("telefone").value.trim();
    const servico = document.getElementById("servico").value;
    const data = dataSelect.value;
    const horario = horarioSelect.value;

    if (nome.split(" ").length < 2) {
        msg.style.color = "red";
        msg.innerText = "Digite nome e sobrenome.";
        return;
    }

    const { error } = await supabase
        .from("agendamentos")
        .insert([{ nome, telefone, servico, data, horario }]);

    if (error) {
        msg.style.color = "red";
        msg.innerText = "Erro ao agendar.";
    } else {
        msg.style.color = "#d4af37";
        msg.innerText = "Agendamento confirmado!";
        form.reset();
        horarioSelect.innerHTML = '<option value="">Selecione um horário</option>';
    }
});

gerarDias();
</script>
